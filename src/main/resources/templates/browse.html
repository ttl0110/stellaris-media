<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head th:replace="~{layout :: head(${result.libraryName} + ' - Browse')}"></head>

<body>
    <!-- Navbar -->
    <nav th:replace="~{layout :: navbar}"></nav>

    <!-- Breadcrumb -->
    <nav th:replace="~{layout :: breadcrumb(${result.breadcrumbs}, ${library})}"></nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Toolbar -->
        <div class="toolbar glass">
            <div class="toolbar-left">
                <!-- Upload Button -->
                <button class="btn btn-primary" onclick="showUploadModal()">
                    <i class='bx bx-upload'></i>
                    <span>Upload</span>
                </button>

                <!-- New Folder Button -->
                <button class="btn btn-glass" onclick="showNewFolderModal()">
                    <i class='bx bx-folder-plus'></i>
                    <span>New Folder</span>
                </button>
            </div>

            <div class="toolbar-right">
                <!-- Stats -->
                <div class="stats-bar">
                    <span class="stat-item">
                        <i class='bx bx-folder'></i>
                        <span th:text="${result.folderCount}">0</span> folders
                    </span>
                    <span class="stat-item">
                        <i class='bx bx-file'></i>
                        <span th:text="${result.fileCount}">0</span> files
                    </span>
                    <span class="stat-item">
                        <i class='bx bx-hdd'></i>
                        <span th:text="${result.totalSizeFormatted}">0 B</span>
                    </span>
                </div>

                <!-- Sort -->
                <select class="sort-select" id="sortSelect" onchange="changeSort()">
                    <option value="name" th:selected="${currentSort == 'name'}">Name</option>
                    <option value="date" th:selected="${currentSort == 'date'}">Date</option>
                    <option value="size" th:selected="${currentSort == 'size'}">Size</option>
                    <option value="type" th:selected="${currentSort == 'type'}">Type</option>
                </select>

                <!-- View Toggle -->
                <div class="view-toggle">
                    <button th:classappend="${currentView == 'grid'} ? 'active' : ''" onclick="setView('grid')"
                        title="Grid View">
                        <i class='bx bx-grid-alt'></i>
                    </button>
                    <button th:classappend="${currentView == 'list'} ? 'active' : ''" onclick="setView('list')"
                        title="List View">
                        <i class='bx bx-list-ul'></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- File Grid/List -->
        <div id="fileContainer" th:class="${currentView == 'grid'} ? 'file-grid' : 'file-list'">
            <!-- Empty state -->
            <div th:if="${#lists.isEmpty(result.items)}" class="empty-state" style="grid-column: 1 / -1;">
                <i class='bx bx-folder-open empty-state-icon'></i>
                <h3 class="empty-state-title">This folder is empty</h3>
                <p class="empty-state-text">Upload files or create a new folder</p>
            </div>

            <!-- File cards -->
            <th:block th:each="item : ${result.items}">
                <div th:replace="~{layout :: fileCard(${item}, ${library})}"></div>
            </th:block>
        </div>
    </main>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" data-action="open">
            <i class='bx bx-folder-open'></i> Open
        </div>
        <div class="context-menu-item" data-action="download">
            <i class='bx bx-download'></i> Download
        </div>
        <div class="context-menu-item" data-action="downloadZip">
            <i class='bx bx-archive'></i> Download as ZIP
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="rename">
            <i class='bx bx-rename'></i> Rename
        </div>
        <div class="context-menu-item" data-action="move">
            <i class='bx bx-move'></i> Move
        </div>
        <div class="context-menu-item" data-action="copy">
            <i class='bx bx-copy'></i> Copy
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" data-action="delete">
            <i class='bx bx-trash'></i> Delete
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Upload Files</h3>
                <button class="modal-close" onclick="hideUploadModal()">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="upload-zone" id="uploadZone">
                    <i class='bx bx-cloud-upload upload-zone-icon'></i>
                    <p class="upload-zone-text">Drag & drop files here or click to browse</p>
                    <input type="file" id="fileInput" multiple>
                </div>
                <div id="uploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressFill"></div>
                    </div>
                    <p id="uploadStatus" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div id="newFolderModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create New Folder</h3>
                <button class="modal-close" onclick="hideNewFolderModal()">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Folder Name</label>
                    <input type="text" class="form-input" id="newFolderName" placeholder="Enter folder name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-glass" onclick="hideNewFolderModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Rename</h3>
                <button class="modal-close" onclick="hideRenameModal()">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">New Name</label>
                    <input type="text" class="form-input" id="renameInput" placeholder="Enter new name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-glass" onclick="hideRenameModal()">Cancel</button>
                <button class="btn btn-primary" onclick="renameItem()">Rename</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Scripts -->
    <script th:replace="~{layout :: scripts}"></script>
    <script th:inline="javascript">
        // Current state
        const library = /*[[${library}]]*/ '';
        const currentPath = /*[[${result.currentPath}]]*/ '';
        let selectedItem = null;

        // Context Menu
        const contextMenu = document.getElementById('contextMenu');

        function showContextMenu(event, button) {
            event.preventDefault();
            event.stopPropagation();

            const card = button.closest('.file-card');
            selectedItem = {
                path: card.dataset.path,
                type: card.dataset.type,
                isDirectory: card.classList.contains('folder')
            };

            // Position menu
            contextMenu.style.left = event.clientX + 'px';
            contextMenu.style.top = event.clientY + 'px';
            contextMenu.classList.add('show');

            // Update menu items based on type
            const downloadZipItem = contextMenu.querySelector('[data-action="downloadZip"]');
            downloadZipItem.style.display = selectedItem.isDirectory ? 'flex' : 'none';
        }

        document.addEventListener('click', () => {
            contextMenu.classList.remove('show');
        });

        // Context menu actions
        contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', () => {
                if (!selectedItem) return;

                const action = item.dataset.action;
                switch (action) {
                    case 'open':
                        if (selectedItem.isDirectory) {
                            window.location.href = `/browse/${library}/${selectedItem.path}`;
                        }
                        break;
                    case 'download':
                        window.location.href = `/download/${library}/${selectedItem.path}`;
                        break;
                    case 'downloadZip':
                        window.location.href = `/download-zip/${library}/${selectedItem.path}`;
                        break;
                    case 'rename':
                        showRenameModal();
                        break;
                    case 'delete':
                        if (confirm('Are you sure you want to delete this item?')) {
                            deleteItem();
                        }
                        break;
                }
            });
        });

        // View toggle
        function setView(view) {
            const container = document.getElementById('fileContainer');
            container.className = view === 'grid' ? 'file-grid' : 'file-list';

            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('button').classList.add('active');

            localStorage.setItem('view', view);
        }

        // Sort
        function changeSort() {
            const sort = document.getElementById('sortSelect').value;
            window.location.href = `/browse/${library}/${currentPath}?sort=${sort}&view=${localStorage.getItem('view') || 'grid'}`;
        }

        // Upload
        function showUploadModal() {
            document.getElementById('uploadModal').classList.add('show');
        }

        function hideUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            if (files.length === 0) return;

            const formData = new FormData();
            formData.append('library', library);
            formData.append('path', currentPath);
            for (const file of files) {
                formData.append('files', file);
            }

            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadStatus').textContent = `Uploading ${files.length} file(s)...`;

            const xhr = new XMLHttpRequest();
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    document.getElementById('progressFill').style.width = percent + '%';
                }
            };

            xhr.onload = () => {
                const result = JSON.parse(xhr.responseText);
                if (result.success) {
                    showToast('success', result.message);
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast('error', result.message);
                }
                hideUploadModal();
            };

            xhr.onerror = () => {
                showToast('error', 'Upload failed');
                hideUploadModal();
            };

            xhr.open('POST', '/api/upload');
            xhr.send(formData);
        }

        // New Folder
        function showNewFolderModal() {
            document.getElementById('newFolderModal').classList.add('show');
            document.getElementById('newFolderName').focus();
        }

        function hideNewFolderModal() {
            document.getElementById('newFolderModal').classList.remove('show');
            document.getElementById('newFolderName').value = '';
        }

        function createFolder() {
            const name = document.getElementById('newFolderName').value.trim();
            if (!name) {
                showToast('error', 'Please enter a folder name');
                return;
            }

            fetch('/api/folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `library=${encodeURIComponent(library)}&path=${encodeURIComponent(currentPath)}&name=${encodeURIComponent(name)}`
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        showToast('success', 'Folder created');
                        window.location.reload();
                    } else {
                        showToast('error', result.message);
                    }
                });

            hideNewFolderModal();
        }

        // Rename
        function showRenameModal() {
            document.getElementById('renameModal').classList.add('show');
            const input = document.getElementById('renameInput');
            input.value = selectedItem.path.split('/').pop();
            input.focus();
            input.select();
        }

        function hideRenameModal() {
            document.getElementById('renameModal').classList.remove('show');
        }

        function renameItem() {
            const newName = document.getElementById('renameInput').value.trim();
            if (!newName) {
                showToast('error', 'Please enter a name');
                return;
            }

            fetch('/api/rename', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `library=${encodeURIComponent(library)}&path=${encodeURIComponent(selectedItem.path)}&newName=${encodeURIComponent(newName)}`
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        showToast('success', 'Renamed successfully');
                        window.location.reload();
                    } else {
                        showToast('error', result.message);
                    }
                });

            hideRenameModal();
        }

        // Delete
        function deleteItem() {
            fetch(`/api/file?library=${encodeURIComponent(library)}&path=${encodeURIComponent(selectedItem.path)}`, {
                method: 'DELETE'
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        showToast('success', 'Deleted successfully');
                        window.location.reload();
                    } else {
                        showToast('error', result.message);
                    }
                });
        }

        // Toast
        function showToast(type, message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class='bx ${type === 'success' ? 'bx-check-circle' : 'bx-error-circle'} toast-icon'></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 300ms ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideUploadModal();
                hideNewFolderModal();
                hideRenameModal();
                contextMenu.classList.remove('show');
            }
        });

        // Enter key for modals
        document.getElementById('newFolderName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') createFolder();
        });

        document.getElementById('renameInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') renameItem();
        });
    </script>
</body>

</html>